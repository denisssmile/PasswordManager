import tkinter as tk
from tkinter import messagebox
import sqlite3
from argon2 import PasswordHasher

# Инициализируем "мясорубку" для паролей
ph = PasswordHasher()


def init_db():
    conn = sqlite3.connect('vault.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS master_key (id INTEGER PRIMARY KEY, hash TEXT)''')
    conn.commit()
    return conn


def is_already_registered():
    conn = init_db()
    cursor = conn.cursor()
    cursor.execute("SELECT hash FROM master_key")
    return cursor.fetchone() is not None


def process_password():
    password = password_entry.get()

    if not password:
        messagebox.showwarning("Ошибка", "Пароль не может быть пустым!")
        return

    if not is_already_registered():
        # РЕГИСТРАЦИЯ
        hashed = ph.hash(password)
        conn = init_db()
        conn.execute("INSERT INTO master_key (hash) VALUES (?)", (hashed,))
        conn.commit()
        messagebox.showinfo("Успех", "Мастер-пароль установлен! Перезапустите программу для входа.")
        root.destroy()
    else:
        # ВХОД
        conn = init_db()
        cursor = conn.cursor()
        cursor.execute("SELECT hash FROM master_key WHERE id = 1")
        stored_hash = cursor.fetchone()[0]

        try:
            ph.verify(stored_hash, password)
            messagebox.showinfo("Доступ", "Сейф открыт! (Тут будет список паролей)")
            # Здесь в Спринте 3 мы откроем новое окно со списком паролей
        except:
            messagebox.showerror("Ошибка", "Неверный мастер-пароль!")


# --- СОЗДАНИЕ ОКНА ---
root = tk.Tk()
root.title("CryptoSafe Manager")
root.geometry("300x200")

# Текст-подсказка
label_text = "Придумайте мастер-пароль:" if not is_already_registered() else "Введите мастер-пароль:"
label = tk.Label(root, text=label_text, pady=10)
label.pack()

# Поле ввода (show="*" прячет символы за звездочками)
password_entry = tk.Entry(root, show="*", width=25)
password_entry.pack(pady=10)

# Кнопка
btn_text = "Зарегистрироваться" if not is_already_registered() else "Войти"
login_btn = tk.Button(root, text=btn_text, command=process_password)
login_btn.pack(pady=10)

root.mainloop()
